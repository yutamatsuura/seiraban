<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>既存システム逆解析 - 正しいロジック抽出</title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .btn:hover {
            background: #0056b3;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .result-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .iframe-container {
            width: 100%;
            height: 600px;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
        }

        .analysis-result {
            background: #e7f3ff;
            border: 1px solid #b6d7ff;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 既存システム逆解析 - 正しいロジック抽出</h1>

        <div class="section">
            <h2>📝 テストケース設定</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="input-group">
                    <label for="testYear">生年</label>
                    <input type="number" id="testYear" value="1982" min="1900" max="2100">
                </div>
                <div class="input-group">
                    <label for="testMonth">生月</label>
                    <input type="number" id="testMonth" value="10" min="1" max="12">
                </div>
                <div class="input-group">
                    <label for="testDay">生日</label>
                    <input type="number" id="testDay" value="12" min="1" max="31">
                </div>
                <div class="input-group">
                    <label for="testGender">性別</label>
                    <select id="testGender">
                        <option value="1">男性</option>
                        <option value="0">女性</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="analyzeExistingSystem()">
                🔬 既存システムを解析
            </button>
            <button class="btn" onclick="extractLogicFromHTML()">
                🧮 HTMLから数値を抽出
            </button>
            <button class="btn" onclick="generateCorrectedLogic()">
                ✅ 正しいロジックを生成
            </button>
        </div>

        <div class="comparison-grid">
            <div class="result-panel">
                <h3>🌐 既存システム（正解）</h3>
                <iframe id="existingSystemFrame"
                        class="iframe-container"
                        src="about:blank"
                        title="既存システム">
                </iframe>
            </div>

            <div class="result-panel">
                <h3>📊 解析結果</h3>
                <div id="analysisResults">
                    <p>「既存システムを解析」ボタンを押してください。</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>🔍 抽出されたデータ</h2>
            <div id="extractedData" class="analysis-result">
                まだデータが抽出されていません。
            </div>
        </div>

        <div class="section">
            <h2>⚡ 修正されたロジック</h2>
            <div id="correctedLogic" class="analysis-result">
                解析完了後に正しいロジックが表示されます。
            </div>
        </div>
    </div>

    <script>
        let extractedSystemData = null;

        function buildExistingSystemUrl() {
            const year = document.getElementById('testYear').value;
            const month = document.getElementById('testMonth').value;
            const day = document.getElementById('testDay').value;
            const gender = document.getElementById('testGender').value;

            const baseUrl = 'https://kigaku-navi.com/qsei/ban_kipou.php';
            const params = new URLSearchParams({
                'birth_y': year,
                'birth_m': month.padStart(2, '0'),
                'birth_d': day.padStart(2, '0'),
                'sex': gender,
                'action': 'calc'
            });

            return `${baseUrl}?${params.toString()}`;
        }

        function analyzeExistingSystem() {
            const url = buildExistingSystemUrl();
            console.log('既存システム解析開始:', url);

            // iframeで既存システムを表示
            const iframe = document.getElementById('existingSystemFrame');
            iframe.src = url;

            // 解析結果を更新
            document.getElementById('analysisResults').innerHTML = `
                <div class="analysis-result">
                    <strong>📍 解析中...</strong><br>
                    URL: ${url}<br><br>
                    <strong>📋 手動確認項目:</strong><br>
                    1. 本命星（年星）の値<br>
                    2. 月命星の値<br>
                    3. 年盤の中央値<br>
                    4. 月盤の中央値<br>
                    5. 日盤の中央値<br>
                    6. 各方位の九星配置<br>
                    7. 吉凶判定結果<br><br>
                    <em>右側のiframeで実際の結果を確認してください</em>
                </div>
            `;

            // iframe読み込み完了時にさらなる解析を実行
            iframe.onload = function() {
                setTimeout(() => {
                    try {
                        // Same-origin policyのため直接アクセスはできないが、
                        // ユーザーが手動で確認できるようにガイドを表示
                        showManualExtractionGuide();
                    } catch (error) {
                        console.log('Same-origin policy により自動抽出はできません');
                        showManualExtractionGuide();
                    }
                }, 2000);
            };
        }

        function showManualExtractionGuide() {
            document.getElementById('analysisResults').innerHTML += `
                <div class="analysis-result success">
                    <strong>✅ 手動抽出ガイド</strong><br><br>

                    <strong>1. 基本情報抽出:</strong><br>
                    - 本命星: [右側で確認] (期待値: 九紫火星)<br>
                    - 月命星: [右側で確認] (期待値: 六白金星)<br><br>

                    <strong>2. 方位盤中央値:</strong><br>
                    - 年盤中央: [右側で確認]<br>
                    - 月盤中央: [右側で確認]<br>
                    - 日盤中央: [右側で確認] (期待値: 7)<br><br>

                    <strong>3. 基盤配置:</strong><br>
                    各方位（北・北東・東・南東・南・南西・西・北西）の九星を確認<br><br>

                    <strong>4. 吉凶判定:</strong><br>
                    - 最大吉方の方位<br>
                    - 五黄殺・暗剣殺の位置<br>
                    - 本命殺・月命殺の位置<br>
                    - 月命的殺・本命的殺の位置<br><br>

                    確認できたら「HTMLから数値を抽出」ボタンを押してください。
                </div>
            `;
        }

        function extractLogicFromHTML() {
            // ユーザーが手動で入力できるフォーム
            document.getElementById('extractedData').innerHTML = `
                <h4>📝 既存システムから読み取った値を入力してください:</h4>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div>
                        <label><strong>本命星（数値）:</strong></label>
                        <input type="number" id="actualYearQsei" placeholder="例: 9" min="1" max="9">
                    </div>
                    <div>
                        <label><strong>月命星（数値）:</strong></label>
                        <input type="number" id="actualMonthQsei" placeholder="例: 6" min="1" max="9">
                    </div>
                    <div>
                        <label><strong>現在年盤中央:</strong></label>
                        <input type="number" id="actualYearCenter" placeholder="例: 3" min="1" max="9">
                    </div>
                    <div>
                        <label><strong>現在月盤中央:</strong></label>
                        <input type="number" id="actualMonthCenter" placeholder="例: 6" min="1" max="9">
                    </div>
                    <div>
                        <label><strong>現在日盤中央:</strong></label>
                        <input type="number" id="actualDayCenter" placeholder="例: 7" min="1" max="9">
                    </div>
                </div>

                <h4>📍 年盤基盤配置（北から時計回り）:</h4>
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; margin: 20px 0;">
                    <input type="number" id="yearKiban0" placeholder="北" min="1" max="9">
                    <input type="number" id="yearKiban1" placeholder="北東" min="1" max="9">
                    <input type="number" id="yearKiban2" placeholder="東" min="1" max="9">
                    <input type="number" id="yearKiban3" placeholder="南東" min="1" max="9">
                    <input type="number" id="yearKiban4" placeholder="南" min="1" max="9">
                    <input type="number" id="yearKiban5" placeholder="南西" min="1" max="9">
                    <input type="number" id="yearKiban6" placeholder="西" min="1" max="9">
                    <input type="number" id="yearKiban7" placeholder="北西" min="1" max="9">
                </div>

                <h4>📍 月盤基盤配置（北から時計回り）:</h4>
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; margin: 20px 0;">
                    <input type="number" id="monthKiban0" placeholder="北" min="1" max="9">
                    <input type="number" id="monthKiban1" placeholder="北東" min="1" max="9">
                    <input type="number" id="monthKiban2" placeholder="東" min="1" max="9">
                    <input type="number" id="monthKiban3" placeholder="南東" min="1" max="9">
                    <input type="number" id="monthKiban4" placeholder="南" min="1" max="9">
                    <input type="number" id="monthKiban5" placeholder="南西" min="1" max="9">
                    <input type="number" id="monthKiban6" placeholder="西" min="1" max="9">
                    <input type="number" id="monthKiban7" placeholder="北西" min="1" max="9">
                </div>

                <button class="btn" onclick="processExtractedData()">
                    ✅ 入力データを処理
                </button>
            `;
        }

        function processExtractedData() {
            // 入力された値を収集
            extractedSystemData = {
                birthInfo: {
                    year: parseInt(document.getElementById('testYear').value),
                    month: parseInt(document.getElementById('testMonth').value),
                    day: parseInt(document.getElementById('testDay').value),
                    yearQsei: parseInt(document.getElementById('actualYearQsei').value),
                    monthQsei: parseInt(document.getElementById('actualMonthQsei').value)
                },
                currentInfo: {
                    year: 2025,
                    month: 9,
                    day: 24,
                    yearCenter: parseInt(document.getElementById('actualYearCenter').value),
                    monthCenter: parseInt(document.getElementById('actualMonthCenter').value),
                    dayCenter: parseInt(document.getElementById('actualDayCenter').value)
                },
                yearKiban: [],
                monthKiban: []
            };

            // 基盤配置を収集
            for (let i = 0; i < 8; i++) {
                extractedSystemData.yearKiban.push(parseInt(document.getElementById(`yearKiban${i}`).value) || 0);
                extractedSystemData.monthKiban.push(parseInt(document.getElementById(`monthKiban${i}`).value) || 0);
            }

            console.log('抽出データ:', extractedSystemData);

            document.getElementById('extractedData').innerHTML += `
                <div class="analysis-result success">
                    <strong>✅ データ抽出完了</strong><br>
                    <pre>${JSON.stringify(extractedSystemData, null, 2)}</pre>
                </div>
            `;
        }

        function generateCorrectedLogic() {
            if (!extractedSystemData) {
                alert('まず既存システムからデータを抽出してください。');
                return;
            }

            // 抽出されたデータを基に正しいロジックを逆算
            const correctedLogic = reverseEngineerLogic(extractedSystemData);

            document.getElementById('correctedLogic').innerHTML = `
                <h4>🎯 逆解析された正しいロジック:</h4>
                <pre>${correctedLogic}</pre>

                <h4>📝 修正が必要なポイント:</h4>
                <ul>
                    <li><strong>年星計算:</strong> 既存の計算式を確認</li>
                    <li><strong>月星計算:</strong> MONTH_TABLEのインデックス確認</li>
                    <li><strong>日星計算:</strong> QseiDayCreaterのロジック確認</li>
                    <li><strong>基盤配置:</strong> QSEI_DATAの kiban8 配列確認</li>
                    <li><strong>方位順序:</strong> POINT_RADIANS の順序確認</li>
                </ul>

                <button class="btn" onclick="generateCorrectedFile()">
                    📄 修正版ファイルを生成
                </button>
            `;
        }

        function reverseEngineerLogic(data) {
            return `
// 逆解析結果 - ${new Date().toISOString()}

// テストケース: ${data.birthInfo.year}年${data.birthInfo.month}月${data.birthInfo.day}日
// 期待される結果:
const EXPECTED_RESULTS = {
    birth: {
        yearQsei: ${data.birthInfo.yearQsei}, // 本命星
        monthQsei: ${data.birthInfo.monthQsei}  // 月命星
    },
    current: {
        yearCenter: ${data.currentInfo.yearCenter},   // 年盤中央
        monthCenter: ${data.currentInfo.monthCenter}, // 月盤中央
        dayCenter: ${data.currentInfo.dayCenter}      // 日盤中央
    },
    kiban: {
        year: [${data.yearKiban.join(', ')}],   // 年盤基盤
        month: [${data.monthKiban.join(', ')}]  // 月盤基盤
    }
};

// 修正が必要な計算式:
// 1. 年星計算式の見直し
// 2. 月星計算のMONTH_TABLEインデックス
// 3. 日星計算アルゴリズム
// 4. 基盤配置の順序・回転
            `;
        }

        function generateCorrectedFile() {
            if (!extractedSystemData) return;

            // 新しいHTMLファイルを生成（別ウィンドウで表示）
            const correctedHTML = generateCorrectedHoibanHTML(extractedSystemData);

            const newWindow = window.open('', '_blank');
            newWindow.document.write(correctedHTML);
            newWindow.document.close();
        }

        function generateCorrectedHoibanHTML(data) {
            return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>修正版方位盤 - 既存システム準拠</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* 前回と同じCSS */
        body { font-family: 'Noto Sans JP', sans-serif; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        /* ... 他のCSSも同様 ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>修正版九星気学方位盤（既存システム準拠）</h1>

        <div class="meta-info">
            <div><strong>検証結果:</strong></div>
            <div>本命星: ${data.birthInfo.yearQsei} (期待値と一致: ${data.birthInfo.yearQsei === 9 ? '✅' : '❌'})</div>
            <div>月命星: ${data.birthInfo.monthQsei} (期待値と一致: ${data.birthInfo.monthQsei === 6 ? '✅' : '❌'})</div>
            <div>日盤中央: ${data.currentInfo.dayCenter} (期待値と一致: ${data.currentInfo.dayCenter === 7 ? '✅' : '❌'})</div>
        </div>

        <div class="hoiban-row">
            <div class="hoiban-section">
                <div class="ban-title">年盤（修正版）</div>
                <svg id="correctedYearBan" width="420" height="420"></svg>
            </div>
            <div class="hoiban-section">
                <div class="ban-title">月盤（修正版）</div>
                <svg id="correctedMonthBan" width="420" height="420"></svg>
            </div>
        </div>

        <div class="debug-info">
            <h3>🔍 検証データ:</h3>
            <pre>${JSON.stringify(data, null, 2)}</pre>
        </div>
    </div>

    <script>
        // 抽出されたデータを使用した正確な実装
        const CORRECTED_DATA = ${JSON.stringify(data, null, 2)};

        // TODO: 抽出されたデータを基に正確な描画を実装
        console.log('修正版データ:', CORRECTED_DATA);

        // 実際の描画ロジックをここに実装
        // （抽出されたデータに基づく）
    </script>
</body>
</html>
            `;
        }

        // ページ読み込み時に自動実行
        window.onload = function() {
            setTimeout(() => {
                analyzeExistingSystem();
            }, 1000);
        };
    </script>
</body>
</html>