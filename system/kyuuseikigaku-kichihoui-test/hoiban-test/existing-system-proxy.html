<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>既存システム結果表示</title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .result-frame {
            width: 100%;
            height: 800px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
        }
        .input-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>既存システム方位盤結果表示</h1>

        <div class="input-section">
            <h3>生年月日入力</h3>
            <input type="date" id="birthDate" value="1982-10-12">
            <select id="gender">
                <option value="male">男性</option>
                <option value="female">女性</option>
            </select>
            <button class="btn" onclick="loadExistingSystemResult()">既存システムの結果を読み込み</button>
            <button class="btn" onclick="loadViaProxy()">プロキシ経由で読み込み</button>
        </div>

        <div id="resultContainer">
            <h3>既存システムの結果:</h3>
            <iframe id="resultFrame" class="result-frame" src="about:blank"></iframe>
        </div>

        <div id="apiResult" style="margin-top: 20px;">
            <h3>API経由の結果:</h3>
            <div id="apiContent"></div>
        </div>
    </div>

    <script>
        function loadExistingSystemResult() {
            const birthDate = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;

            // 生年月日をパラメータに変換
            const date = new Date(birthDate);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            // 既存システムのURLにパラメータを付けて表示
            const existingSystemUrl = `https://kigaku-navi.com/qsei/ban_kipou.php?year=${year}&month=${month}&day=${day}&gender=${gender}`;

            document.getElementById('resultFrame').src = existingSystemUrl;
            console.log('読み込み中:', existingSystemUrl);
        }

        async function loadViaProxy() {
            const birthDate = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;

            const date = new Date(birthDate);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            try {
                // プロキシサーバー経由でデータを取得
                const response = await fetch(`/api/proxy-existing-system`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        year: year,
                        month: month,
                        day: day,
                        gender: gender
                    })
                });

                if (response.ok) {
                    const html = await response.text();
                    document.getElementById('apiContent').innerHTML = html;
                } else {
                    document.getElementById('apiContent').innerHTML =
                        '<p style="color: red;">エラー: データの取得に失敗しました</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('apiContent').innerHTML =
                    '<p style="color: red;">ネットワークエラーが発生しました</p>';
            }
        }

        // ページ読み込み時に1982年10月12日の結果を自動表示
        window.onload = function() {
            setTimeout(() => {
                loadExistingSystemResult();
            }, 1000);
        };
    </script>
</body>
</html>