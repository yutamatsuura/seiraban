# 要件定義書（更新版）

## 📅 更新日: 2024年9月24日

## 1. システム概要

### 1.1 プロジェクト名
九星気学・吉方位鑑定システム

### 1.2 目的
ユーザーの生年月日から九星を算出し、吉方位・凶方位を鑑定するWebアプリケーション

## 2. 機能要件

### 2.1 基本機能
| 機能 | 説明 | 優先度 | 状態 |
|------|------|--------|------|
| 九星計算 | 生年月日から本命星・月命星を算出 | 高 | ✅完了 |
| 方位盤表示 | 8角形の方位盤で年盤・月盤・日盤を表示 | 高 | ✅完了 |
| 吉凶判定 | 各方位の吉凶を判定・色分け表示 | 高 | ✅完了 |
| ユーザー管理 | 登録・ログイン・プロフィール管理 | 中 | 🚧未着手 |
| 履歴管理 | 過去の鑑定結果を保存・閲覧 | 中 | 🚧未着手 |
| PDF出力 | 鑑定結果をPDFで出力 | 低 | 🚧未着手 |

### 2.2 変更された要件

#### 🔄 計算ロジックの差異対応
**変更前**: 既存システム（kigaku-navi.com）と完全互換
**変更後**: 流派の違いを認識し、独自実装も選択肢に含める

**理由**:
- 日九星計算で既存システムと2-4九星の差異確認
- 九星気学は流派により計算方法が異なることが判明
- 完全互換より正確性・一貫性を重視

#### 🔄 UI/UXデザイン
**変更前**: 単純な表形式での表示
**変更後**: 8角形の方位盤での視覚的表示

**追加要件**:
- 東西南北の明確な表示（南を上に配置）
- 吉凶の色分け（最大吉、吉方、暗剣殺、五黄殺等）
- レスポンシブデザイン対応

## 3. 非機能要件

### 3.1 パフォーマンス要件
| 項目 | 要件 | 現状 |
|------|------|------|
| レスポンス時間 | 3秒以内 | ✅達成 |
| 同時接続数 | 100ユーザー | 🚧未検証 |
| 可用性 | 99.9% | 🚧未実装 |

### 3.2 セキュリティ要件
- [ ] HTTPSによる通信暗号化
- [ ] パスワードのハッシュ化保存
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] CSRF対策

### 3.3 互換性要件
| ブラウザ | バージョン | 対応状況 |
|----------|------------|----------|
| Chrome | 最新2バージョン | ✅対応 |
| Firefox | 最新2バージョン | ✅対応 |
| Safari | 最新2バージョン | ⚠️要検証 |
| Edge | 最新2バージョン | ⚠️要検証 |

## 4. システム構成

### 4.1 アーキテクチャ
```
┌─────────────────┐
│   フロントエンド   │ TypeScript, HTML5, CSS3
├─────────────────┤
│      API層       │ REST API (Node.js/Python)
├─────────────────┤
│   ビジネスロジック │ 九星計算エンジン
├─────────────────┤
│  データベース層    │ PostgreSQL/MySQL
└─────────────────┘
```

### 4.2 ディレクトリ構成
```
kyuuseikigaku-kichihoui/
├── src/
│   ├── js/
│   │   ├── bans/          # 九星計算ロジック ✅
│   │   ├── times/         # 日時処理 ✅
│   │   └── utils/         # ユーティリティ ✅
│   ├── css/               # スタイルシート 🚧
│   └── components/        # UIコンポーネント 🚧
├── hoiban-test/           # テストツール ✅
├── docs/                  # ドキュメント 🚧
└── tests/                 # テストコード 🚧
```

## 5. データモデル

### 5.1 主要エンティティ
```typescript
// ユーザー
interface User {
  id: string;
  email: string;
  password: string;
  birthDate: Date;
  gender: 'male' | 'female';
  honmeiSei: number;  // 本命星
  getsumeiSei: number; // 月命星
}

// 鑑定結果
interface KanteiResult {
  id: string;
  userId: string;
  targetDate: Date;
  nenban: HoibanData;
  getsuban: HoibanData;
  nichiban: HoibanData;
  kichiHoui: Direction[];
  kyouHoui: Direction[];
}

// 方位盤データ
interface HoibanData {
  center: number;
  directions: {
    [key: string]: {
      qsei: number;
      kichou?: string;
    }
  }
}
```

## 6. API仕様

### 6.1 エンドポイント一覧
| メソッド | パス | 説明 | 実装状況 |
|---------|------|------|----------|
| POST | /api/auth/register | ユーザー登録 | 🚧 |
| POST | /api/auth/login | ログイン | 🚧 |
| GET | /api/user/profile | プロフィール取得 | 🚧 |
| POST | /api/kantei/calculate | 鑑定計算 | 🚧 |
| GET | /api/kantei/history | 鑑定履歴取得 | 🚧 |

## 7. テスト計画

### 7.1 テスト項目
- [x] 九星計算ロジックの単体テスト
- [x] 既存システムとの比較テスト
- [ ] API統合テスト
- [ ] UIテスト
- [ ] パフォーマンステスト
- [ ] セキュリティテスト

## 8. リリース計画

### Phase 1: MVP（最小機能版）
**期限**: 2024年10月末
- 基本的な九星計算
- 方位盤表示
- 吉凶判定

### Phase 2: 機能拡張版
**期限**: 2024年12月末
- ユーザー管理
- 履歴保存
- PDF出力

### Phase 3: 完全版
**期限**: 2025年2月末
- 高度な鑑定機能
- 外部API連携
- モバイルアプリ対応

## 9. 決定事項・課題

### ✅ 決定事項
1. 8角形の方位盤UIを採用
2. TypeScriptでの実装
3. 南を上に配置する伝統的な方位表示

### ⚠️ 要決定事項
1. **計算ロジックの選択**
   - A: 既存システム準拠（日九星で差異あり）
   - B: ローカルシステム準拠
   - C: 独自の最適化版

2. **バックエンド技術選択**
   - Node.js (TypeScript統一)
   - Python (FastAPI)

3. **データベース選択**
   - PostgreSQL
   - MySQL
   - MongoDB

### 🚨 リスク・課題
1. 流派による計算方法の違いへの対応
2. 古いブラウザでの8角形表示（clip-path）
3. 大量データ処理時のパフォーマンス

## 10. 参考資料
- 既存システム: https://kigaku-navi.com/qsei/ban_kipou.php
- 九星計算参考: https://keisan.casio.jp/exec/system/1207304031
- 暦注計算: http://koyomi.vis.ne.jp/sub/rekicyuu_doc01.htm#9sei