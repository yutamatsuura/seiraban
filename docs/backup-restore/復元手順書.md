# 🔒 完全復元手順書

## このバックアップについて
- **作成日時**: 2025年9月23日
- **バックアップ状態**: main.py実装で診断作成機能が正常動作する状態
- **Gitコミット**: 8c4a42b "🔒 BACKUP: Working state - main.py implementation restored"

## 🚀 完全復元手順

### ステップ1: Gitから復元
```bash
# プロジェクトディレクトリに移動
cd /Users/lennon/projects/inoue4

# このバックアップ状態に復元
git checkout 8c4a42b

# 復元確認
git log --oneline -1
# 結果: 8c4a42b 🔒 BACKUP: Working state - main.py implementation restored
```

### ステップ2: バックエンド環境設定
```bash
# バックエンドディレクトリに移動
cd backend

# Python仮想環境作成（初回のみ）
python3 -m venv venv

# 仮想環境有効化
source venv/bin/activate

# 依存関係インストール
pip install -r requirements.txt

# データベース接続確認
python3 -c "
import asyncpg
import asyncio
async def test():
    conn = await asyncpg.connect('postgresql://neondb_owner:npg_FLj8pL8L7Rj9@ep-bitter-paper-a5gzfqjg.us-east-2.aws.neon.tech/neondb?sslmode=require')
    print('データベース接続OK')
    await conn.close()
asyncio.run(test())
"
```

### ステップ3: フロントエンド環境設定
```bash
# フロントエンドディレクトリに移動
cd ../frontend

# 依存関係インストール
npm install

# パッケージ確認
npm list vue
```

### ステップ4: 両サーバー起動
```bash
# バックエンド起動（ターミナル1）
cd backend
./venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8502 --reload

# フロントエンド起動（ターミナル2）
cd frontend
npm run dev
```

### ステップ5: 動作確認
1. **フロントエンド**: http://localhost:5173
2. **バックエンドAPI**: http://localhost:8502/docs
3. **テスト手順**:
   - ログイン画面でログイン
   - 診断作成を実行
   - 診断結果の表示確認

## 📋 復元時チェックリスト

### ✅ 必須確認項目
- [ ] Git状態がコミット8c4a42bになっている
- [ ] `backend/main.py`が存在し、約1500行程度
- [ ] `backend/app/`ディレクトリが存在しない（app_backupに移動済み）
- [ ] バックエンドが8502ポートで起動
- [ ] フロントエンドが5173ポートで起動
- [ ] 診断作成機能が動作する
- [ ] エラーログにvalidation errorが出ない

### ⚠️ 確認時の注意点
- データベース接続エラーが出る場合は、NEON Cloudの状態確認
- ポート競合エラーの場合は、他のプロセスを終了
- npm installエラーの場合は、`npm cache clean --force`を実行

## 🔧 トラブルシューティング

### バックエンドエラー
```bash
# 「No module named 'app'」エラーの場合
ls backend/
# app_backupは存在するが、appは存在しないことを確認

# main.pyが自己完結型になっていることを確認
grep -n "from app" backend/main.py
# 結果: (何も表示されないはず)
```

### フロントエンドエラー
```bash
# Node.js/npmバージョン確認
node --version  # v18以上推奨
npm --version   # v8以上推奨

# キャッシュクリア
cd frontend
rm -rf node_modules package-lock.json
npm install
```

### データベースエラー
```bash
# 接続テスト
cd backend
python3 -c "
from main import engine
print('データベース接続:', engine.url)
"
```

## 📝 復元後の状態

### 正常動作する機能
- ✅ ユーザー認証（固定ユーザーID=70）
- ✅ 診断作成・保存
- ✅ 診断結果表示
- ✅ テンプレート設定
- ✅ データベース連携

### 現在の制限事項（本番環境で要修正）
- ⚠️ 固定認証（user_id=70固定）
- ⚠️ 管理者権限常時有効（admin_mode=True）
- ⚠️ ハードコードされたデータベース接続情報
- ⚠️ エラーハンドリングの簡素化

## 🎯 次回開発再開時の推奨手順
1. この復元手順で完全復元
2. 現在の動作確認
3. 本番品質改善の段階的実装
4. 各段階でのバックアップ作成

---
**重要**: このバックアップは診断機能が完全動作する最後の安定状態です。
開発再開時は必ずこの状態から始めることを強く推奨します。